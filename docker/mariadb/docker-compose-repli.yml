# üåê D√©finition du R√©seau Priv√©
networks:
  backend_db:
    driver: bridge
    ipam:
      config:
        - subnet: 10.5.0.0/24

x-template: &template
  image: mariadb_ssh:004
  restart: unless-stopped
  privileged: true
  environment:
    - MARIADB_ROOT_PASSWORD=rootpass
    # Astuce Expert : D√©finit le DNS interne pour la r√©solution de noms
    - MARIADB_ROOT_HOST=%
  networks:
    backend_db:


services:
  # =========================================================================
  # ÔøΩ REPLICATION LEGACY (Classic setup)
  # =========================================================================

  # ÔøΩüü¢ Serveur 1
  mariadb_01:
    <<: *template
    profiles: [ "repli-legacy" ]
    hostname: frm01
    ports:
      - "23001:22"
      - "3411:3306"
    volumes:
      - "./datadir_01:/var/lib/mysql"
      - "./backups_01:/backups"
      - "./custom_1.cnf:/etc/mysql/mariadb.conf.d/999_custom.cnf:ro"
      - "./init-permissions.sql:/docker-entrypoint-initdb.d/init-permissions.sql:ro"
      - "./ssl:/etc/mysql/ssl:ro"
      - "./ssl.cnf:/etc/mysql/conf.d/ssl.cnf:ro"
    networks:
      backend_db:
        ipv4_address: 10.5.0.11

  # üü¢ Serveur 2
  mariadb_02:
    <<: *template
    profiles: [ "repli-legacy" ]
    hostname: frm02
    ports:
      - "23002:22"
      - "3412:3306"
    volumes:
      - "./datadir_02:/var/lib/mysql"
      - "./backups_02:/backups"
      - "./custom_2.cnf:/etc/mysql/mariadb.conf.d/999_custom.cnf:ro"
      - "./init-permissions.sql:/docker-entrypoint-initdb.d/init-permissions.sql:ro"
      - "./ssl:/etc/mysql/ssl:ro"
      - "./ssl.cnf:/etc/mysql/conf.d/ssl.cnf:ro"
    networks:
      backend_db:
        ipv4_address: 10.5.0.12

  # üü¢ Serveur 3
  mariadb_03:
    <<: *template
    profiles: [ "repli-legacy" ]
    hostname: frm03
    ports:
      - "23003:22"
      - "3413:3306"
    volumes:
      - "./datadir_03:/var/lib/mysql"
      - "./backups_03:/backups"
      - "./custom_3.cnf:/etc/mysql/mariadb.conf.d/999_custom.cnf:ro"
      - "./init-permissions.sql:/docker-entrypoint-initdb.d/init-permissions.sql:ro"
      - "./ssl:/etc/mysql/ssl:ro"
      - "./ssl.cnf:/etc/mysql/conf.d/ssl.cnf:ro"
    networks:
      backend_db:
        ipv4_address: 10.5.0.13

  # üîµ Load Balancer (HAProxy)
  haproxy_repli:
    image: haproxy:latest
    profiles: [ "repli-legacy" ]
    container_name: haproxy_repli
    restart: unless-stopped
    volumes:
      - ./haproxy-repli.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - "3406:3306" # Writes (Master)
      - "3407:3307" # Reads (Slaves)
      - "8405:8404" # Stats on 8405 to avoid conflict with Galera HAProxy
    networks:
      backend_db:
        ipv4_address: 10.5.0.100
    depends_on:
      - mariadb_01
      - mariadb_02
      - mariadb_03

  # =========================================================================
  # üü£ MARIADB 11 REPLICATION (Modern setup)
  # =========================================================================

  m11_master:
    image: ${DB_TYPE:-mariadb}:${DB_VERSION:-11.4}
    profiles: [ "repli-m11" ]
    environment:
      MYSQL_ROOT_PASSWORD: ${ROOT_PASSWORD:-secret}
      MYSQL_DATABASE: ${DB_NAME:-testdb}
    command: >
      --server-id=1 --log-bin=mysql-bin --relay-log=slave-relay-bin --log-slave-updates --max-connections=200
    ports:
      - "3306:3306"
    volumes:
      - ./mariadb11-repli-master-init:/docker-entrypoint-initdb.d
      - ./mariadb11-repli.env_example:/.env
      - ./data/mariadb11/master:/var/lib/mysql
    networks:
      - backend_db

  m11_slave1:
    image: ${DB_TYPE:-mariadb}:${DB_VERSION:-11.4}
    profiles: [ "repli-m11" ]
    depends_on:
      - m11_master
    environment:
      MYSQL_ROOT_PASSWORD: ${ROOT_PASSWORD:-secret}
    command: >
      --server-id=2 --report-host=slave1 --log-bin=mysql-bin --relay-log=slave-relay-bin --log-slave-updates --read-only=1 --max-connections=200
    volumes:
      - ./mariadb11-repli-slave-init:/docker-entrypoint-initdb.d
      - ./mariadb11-repli.env_example:/.env
      - ./data/mariadb11/slave1:/var/lib/mysql
    ports:
      - "3307:3306"
    networks:
      - backend_db

  m11_slave2:
    image: ${DB_TYPE:-mariadb}:${DB_VERSION:-11.4}
    profiles: [ "repli-m11" ]
    depends_on:
      - m11_master
    environment:
      MYSQL_ROOT_PASSWORD: ${ROOT_PASSWORD:-secret}
    command: >
      --server-id=3 --report-host=slave2 --log-bin=mysql-bin --relay-log=slave-relay-bin --log-slave-updates --read-only=1 --max-connections=200
    volumes:
      - ./mariadb11-repli-slave-init:/docker-entrypoint-initdb.d
      - ./mariadb11-repli.env_example:/.env
      - ./data/mariadb11/slave2:/var/lib/mysql
    ports:
      - "3308:3306"
    networks:
      - backend_db

  m11_slave3:
    image: ${DB_TYPE:-mariadb}:${DB_VERSION:-11.4}
    profiles: [ "repli-m11" ]
    depends_on:
      - m11_master
    environment:
      MYSQL_ROOT_PASSWORD: ${ROOT_PASSWORD:-secret}
    command: >
      --server-id=4 --report-host=slave3 --log-bin=mysql-bin --relay-log=slave-relay-bin --log-slave-updates --read-only=1 --max-connections=200
    volumes:
      - ./mariadb11-repli-slave-init:/docker-entrypoint-initdb.d
      - ./mariadb11-repli.env_example:/.env
      - ./data/mariadb11/slave3:/var/lib/mysql
    ports:
      - "3309:3306"
    networks:
      - backend_db
